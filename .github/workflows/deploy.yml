name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli --version 0.2.105

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Create site directory
        run: |
          mkdir -p target/site/pkg
          mkdir -p target/site/public

      - name: Build Tailwind CSS
        run: |
          cd frontend && npx tailwindcss -i ./style/tailwind.css -o ../target/site/pkg/xforcesolutions.css --minify

      - name: Build WASM frontend
        run: |
          cargo build --release --target wasm32-unknown-unknown --manifest-path frontend/Cargo.toml --features hydrate

      - name: Verify WASM file exists
        run: |
          if [ ! -f target/wasm32-unknown-unknown/release/frontend.wasm ]; then
            echo "ERROR: WASM file not found at target/wasm32-unknown-unknown/release/frontend.wasm"
            echo "Listing target directory:"
            ls -la target/wasm32-unknown-unknown/release/ 2>/dev/null || echo "Directory does not exist"
            exit 1
          fi
          echo "✓ WASM file found"

      - name: Generate WASM bindings
        run: |
          wasm-bindgen target/wasm32-unknown-unknown/release/frontend.wasm \
            --out-dir target/site/pkg \
            --target web \
            --no-typescript \
            --out-name frontend
          echo "✓ WASM bindings generated"

      - name: Copy static assets
        run: |
          echo "=== EXTENSIVE DEBUG: Copying static assets ==="
          echo "Current directory: $(pwd)"
          echo "Repository name: xforcesolutions"
          echo "GitHub Pages base path: /xforcesolutions/"
          echo ""
          echo "=== Checking source directory ==="
          if [ -d frontend/public/images ]; then
            echo "✓ Found frontend/public/images directory"
            echo "Contents of frontend/public/images:"
            ls -lah frontend/public/images/ | head -20
            echo ""
            echo "=== Creating target directory ==="
            mkdir -p target/site/images
            echo "✓ Created target/site/images"
            echo ""
            echo "=== Copying images ==="
            echo "Listing ALL files in source before copy:"
            ls -lah frontend/public/images/ | head -30
            echo ""
            echo "Copying all images:"
            cp -v frontend/public/images/* target/site/images/ 2>&1
            echo ""
            echo "=== EXPLICITLY FORCING tino.webp copy ==="
            if [ -f frontend/public/images/tino.webp ]; then
              echo "✓✓✓ tino.webp EXISTS IN SOURCE ✓✓✓"
              cp -vf frontend/public/images/tino.webp target/site/images/tino.webp
              echo "Verifying copy:"
              ls -lah target/site/images/tino.webp
              file target/site/images/tino.webp || echo "file command not available"
            else
              echo "✗✗✗ tino.webp NOT IN SOURCE ✗✗✗"
              echo "Full listing of frontend/public/images:"
              ls -la frontend/public/images/
              echo "Checking for case variations:"
              find frontend/public/images -iname "*tino*" || echo "No tino files found"
            fi
            echo ""
            echo "=== Verifying copied files ==="
            echo "Contents of target/site/images:"
            ls -lah target/site/images/ | head -20
            echo ""
            echo "=== File size check ==="
            echo "Checking for tino.webp:"
            if [ -f target/site/images/tino.webp ]; then
              echo "✓ tino.webp exists"
              echo "  Size: $(stat -f%z target/site/images/tino.webp 2>/dev/null || stat -c%s target/site/images/tino.webp 2>/dev/null || echo 'unknown') bytes"
              echo "  Path: $(realpath target/site/images/tino.webp 2>/dev/null || echo target/site/images/tino.webp)"
            else
              echo "✗✗✗ tino.webp NOT FOUND ✗✗✗"
            fi
            echo ""
            echo "Checking for tino.jpg:"
            if [ -f target/site/images/tino.jpg ]; then
              echo "✓ tino.jpg exists"
              echo "  Size: $(stat -f%z target/site/images/tino.jpg 2>/dev/null || stat -c%s target/site/images/tino.jpg 2>/dev/null || echo 'unknown') bytes"
            else
              echo "✗✗✗ tino.jpg NOT FOUND ✗✗✗"
            fi
            echo ""
            echo "=== ALL FILES IN IMAGES DIRECTORY ==="
            echo "Source (frontend/public/images):"
            ls -lah frontend/public/images/ | grep -i tino || echo "No tino files found in source"
            echo ""
            echo "Target (target/site/images):"
            ls -lah target/site/images/ | grep -i tino || echo "No tino files found in target"
            echo ""
            echo "=== COMPLETE FILE LIST IN TARGET ==="
            find target/site/images -type f -name "*tino*" || echo "No tino files found"
          else
            echo "✗✗✗ frontend/public/images directory NOT FOUND ✗✗✗"
            echo "Listing frontend/public:"
            ls -la frontend/public/ || echo "frontend/public doesn't exist"
            echo "Listing frontend:"
            ls -la frontend/ | head -20
          fi
          echo ""
          echo ""
          echo "=== CRITICAL: Copying ALL images to public/images (where they actually get served) ==="
          mkdir -p target/site/public/images
          mkdir -p target/site/images
          if [ -d frontend/public/images ]; then
            echo "=== METHOD 1: Copying ALL images using find (more reliable) ==="
            find frontend/public/images -type f \( -name "*.webp" -o -name "*.svg" -o -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) -exec cp -v {} target/site/public/images/ \;
            find frontend/public/images -type f \( -name "*.webp" -o -name "*.svg" -o -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" \) -exec cp -v {} target/site/images/ \;
            echo ""
            echo "=== METHOD 2: Explicitly copying tino.webp with multiple methods ==="
            if [ -f frontend/public/images/tino.webp ]; then
              echo "✓✓✓ tino.webp EXISTS IN SOURCE ✓✓✓"
              # Method 2a: Direct copy
              cp -vf frontend/public/images/tino.webp target/site/public/images/tino.webp
              cp -vf frontend/public/images/tino.webp target/site/images/tino.webp
              # Method 2b: Using install command
              install -v -m 644 frontend/public/images/tino.webp target/site/public/images/tino.webp 2>/dev/null || cp -vf frontend/public/images/tino.webp target/site/public/images/tino.webp
              install -v -m 644 frontend/public/images/tino.webp target/site/images/tino.webp 2>/dev/null || cp -vf frontend/public/images/tino.webp target/site/images/tino.webp
              # Method 2c: Using cat (bypasses any cp issues)
              cat frontend/public/images/tino.webp > target/site/public/images/tino.webp 2>/dev/null || cp -vf frontend/public/images/tino.webp target/site/public/images/tino.webp
              cat frontend/public/images/tino.webp > target/site/images/tino.webp 2>/dev/null || cp -vf frontend/public/images/tino.webp target/site/images/tino.webp
              echo "Verifying all copies:"
              ls -lah target/site/public/images/tino.webp 2>/dev/null || echo "Missing from public/images"
              ls -lah target/site/images/tino.webp 2>/dev/null || echo "Missing from images"
              file target/site/public/images/tino.webp 2>/dev/null || echo "file command not available"
            else
              echo "✗✗✗ tino.webp NOT IN SOURCE ✗✗✗"
              echo "Full listing:"
              ls -la frontend/public/images/ | grep -i tino || echo "No tino files"
            fi
            echo ""
            echo "=== VERIFYING tino.webp in ALL locations ==="
            for loc in "target/site/public/images" "target/site/images"; do
              if [ -f "$loc/tino.webp" ]; then
                echo "✓✓✓ tino.webp EXISTS in $loc/ ✓✓✓"
                ls -lah "$loc/tino.webp"
              else
                echo "✗✗✗ tino.webp MISSING from $loc/ ✗✗✗"
              fi
            done
            echo ""
            echo "=== Complete file listing in public/images ==="
            ls -lah target/site/public/images/ | head -30
          fi
          echo ""
          echo "=== Copying docs to target/site/docs (ROOT LEVEL) ==="
          if [ -d frontend/public/docs ]; then
            mkdir -p target/site/docs
            cp -r frontend/public/docs/* target/site/docs/ 2>/dev/null || true
            echo "✓ Copied docs to target/site/docs/"
            echo "Verifying docs files:"
            ls -lah target/site/docs/ | head -10
            if [ -f target/site/docs/index.html ]; then
              echo "✓✓✓ docs/index.html EXISTS ✓✓✓"
            else
              echo "✗✗✗ docs/index.html MISSING ✗✗✗"
            fi
          else
            echo "✗✗✗ frontend/public/docs directory NOT FOUND ✗✗✗"
            echo "Listing frontend/public:"
            ls -la frontend/public/ 2>/dev/null | head -20
          fi

      - name: Create .nojekyll file
        run: |
          touch target/site/.nojekyll
          echo "Created .nojekyll file for GitHub Pages"

      - name: Copy favicon
        run: |
          if [ -f frontend/public/images/favicon.svg ]; then
            cp frontend/public/images/favicon.svg target/site/favicon.svg
            echo "✓ Favicon copied"
          else
            echo "⚠ Favicon not found (optional)"
          fi

      - name: Create index.html
        run: |
          cat > target/site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en" class="dark">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>XFSolutions - Professional Solutions</title>
              <link rel="icon" type="image/svg+xml" href="/xforcesolutions/favicon.svg">
              <link rel="stylesheet" href="./pkg/xforcesolutions.css">
              <script>
                  // Set base path for images and assets
                  window.BASE_PATH = '/xforcesolutions';
              </script>
              <script type="module">
                  import init, { hydrate } from './pkg/frontend.js';
                  init().then(() => {
                      hydrate();
                  }).catch(console.error);
              </script>
          </head>
          <body>
              <noscript>You need to enable JavaScript to run this app.</noscript>
              <div id="app-root"></div>
          </body>
          </html>
          EOF

      - name: Create 404.html for SPA routing
        run: |
          cat > target/site/404.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en" class="dark">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>XFSolutions - Professional Solutions</title>
              <link rel="icon" type="image/svg+xml" href="/xforcesolutions/favicon.svg">
              <link rel="stylesheet" href="./pkg/xforcesolutions.css">
              <script>
                  // Set base path for images and assets
                  window.BASE_PATH = '/xforcesolutions';
              </script>
              <script type="module">
                  import init, { hydrate } from './pkg/frontend.js';
                  init().then(() => {
                      hydrate();
                  }).catch(console.error);
              </script>
          </head>
          <body>
              <noscript>You need to enable JavaScript to run this app.</noscript>
              <div id="app-root"></div>
          </body>
          </html>
          EOF
          echo "✓ Created 404.html for GitHub Pages SPA routing"

      - name: Verify build artifacts
        run: |
          echo "=== EXTENSIVE DEBUG: Final site structure ==="
          echo "=== Site root directory ==="
          ls -lah target/site/ || true
          echo ""
          echo "=== Images directory (CRITICAL) ==="
          if [ -d target/site/images ]; then
            echo "✓ Images directory exists"
            echo "Full contents:"
            ls -lah target/site/images/ || true
            echo ""
            echo "=== Testing tino.webp specifically ==="
            if [ -f target/site/images/tino.webp ]; then
              echo "✓✓✓ tino.webp EXISTS ✓✓✓"
              file target/site/images/tino.webp || echo "file command not available"
              du -h target/site/images/tino.webp || echo "du command not available"
            else
              echo "✗✗✗ tino.webp MISSING ✗✗✗"
              echo "Files in images directory:"
              find target/site/images -type f || echo "No files found"
            fi
          else
            echo "✗✗✗ Images directory MISSING ✗✗✗"
          fi
          echo ""
          echo "=== Pkg directory ==="
          ls -lah target/site/pkg/ || true
          echo "=== WASM build output ==="
          ls -la target/wasm32-unknown-unknown/release/*.wasm 2>/dev/null || echo "No WASM files found in expected location"
          echo "=== Checking for required files ==="
          MISSING_FILES=0
          if [ ! -f target/site/index.html ]; then
            echo "✗ index.html missing"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            echo "✓ index.html exists"
          fi
          if [ ! -f target/site/pkg/xforcesolutions.css ]; then
            echo "✗ CSS missing"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            echo "✓ CSS exists"
          fi
          if [ ! -f target/site/pkg/frontend.js ]; then
            echo "✗ JS missing"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            echo "✓ JS exists"
          fi
          if [ ! -f target/site/pkg/frontend_bg.wasm ]; then
            echo "✗ WASM missing"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            echo "✓ WASM exists"
          fi
          echo "=== Checking image files ==="
          if [ -f target/site/images/tino.webp ]; then
            echo "✓ tino.webp exists"
          else
            echo "✗ tino.webp missing (optional)"
          fi
          if [ -f target/site/images/hero.webp ]; then
            echo "✓ hero.webp exists"
          else
            echo "✗ hero.webp missing (optional)"
          fi
          if [ -f target/site/favicon.svg ]; then
            echo "✓ favicon.svg exists"
          else
            echo "✗ favicon.svg missing (optional)"
          fi
          if [ -f target/site/404.html ]; then
            echo "✓ 404.html exists"
          else
            echo "✗ 404.html missing"
            MISSING_FILES=$((MISSING_FILES + 1))
          fi
          if [ $MISSING_FILES -gt 0 ]; then
            echo "ERROR: $MISSING_FILES required file(s) are missing!"
            exit 1
          fi
          echo "✓ All required files exist"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Final artifact verification
        run: |
          echo "=== FINAL ARTIFACT VERIFICATION BEFORE UPLOAD ==="
          echo "Complete directory tree of target/site:"
          find target/site -type f | sort
          echo ""
          echo "=== Critical files check ==="
          echo "index.html: $([ -f target/site/index.html ] && echo 'EXISTS' || echo 'MISSING')"
          echo "404.html: $([ -f target/site/404.html ] && echo 'EXISTS' || echo 'MISSING')"
          echo ".nojekyll: $([ -f target/site/.nojekyll ] && echo 'EXISTS' || echo 'MISSING')"
          echo "favicon.svg: $([ -f target/site/favicon.svg ] && echo 'EXISTS' || echo 'MISSING')"
          echo "tino.webp: $([ -f target/site/images/tino.webp ] && echo 'EXISTS' || echo 'MISSING')"
          echo ""
          echo "=== Images directory tree ==="
          find target/site/images -type f 2>/dev/null | head -20 || echo "Images directory not found"
          echo ""
          echo "=== CRITICAL: TINO IMAGE CHECK ==="
          echo "Looking for tino.webp in images/:"
          if [ -f target/site/images/tino.webp ]; then
            echo "✓✓✓ tino.webp EXISTS in images/ ✓✓✓"
            ls -lah target/site/images/tino.webp
          else
            echo "✗✗✗ tino.webp MISSING from images/ ✗✗✗"
          fi
          echo ""
          echo "Looking for tino.webp in public/images/ (CRITICAL - THIS IS WHERE ARTIFACT SERVES FROM):"
          if [ -f target/site/public/images/tino.webp ]; then
            echo "✓✓✓ tino.webp EXISTS in public/images/ ✓✓✓"
            ls -lah target/site/public/images/tino.webp
          else
            echo "✗✗✗ tino.webp MISSING from public/images/ ✗✗✗"
            echo "  This is the location that appears in the artifact!"
            echo "  Available tino files in public/images:"
            find target/site/public/images -type f -iname "*tino*" 2>/dev/null || echo "  None found"
          fi
          echo ""
          echo "Looking for tino.jpg:"
          if [ -f target/site/images/tino.jpg ]; then
            echo "✓✓✓ tino.jpg EXISTS ✓✓✓"
            ls -lah target/site/images/tino.jpg
          else
            echo "✗✗✗ tino.jpg MISSING ✗✗✗"
            echo "  Code references /images/tino.jpg but file doesn't exist!"
            echo "  Available tino files:"
            find target/site/images -type f -iname "*tino*" || echo "  None found"
          fi
          echo ""
          echo "=== ALL IMAGE FILES IN TARGET/images ==="
          ls -lah target/site/images/ | head -30
          echo ""
          echo "=== ALL IMAGE FILES IN TARGET/public/images (ARTIFACT LOCATION) ==="
          ls -lah target/site/public/images/ | head -30

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: target/site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

